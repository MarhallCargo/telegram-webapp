<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: #f9fafb;
            padding: 20px;
            color: #2c2e33;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .section {
            background-color: #ffffff;
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        }
        button, .button {
            display: inline-block;
            padding: 10px 16px;
            margin: 6px 4px;
            background-color: #e47979;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
        }
        button:hover, .button:hover {
            background-color: #d16565;
        }
        .order, .topup {
            border-bottom: 1px solid #eee;
            padding: 12px 0;
        }
        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            border: 1px solid #ccc;
            border-radius: 8px;
            resize: vertical;
            font-size: 13px;
        }
        input::placeholder, textarea::placeholder {
            opacity: 0.5;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.username }}!</h1>

    <div class="section">
        <p><strong>–ë–∞–ª–∞–Ω—Å:</strong> {{ user.balance if user.balance is defined else 0 }} —é–∞–Ω–µ–π</p>
        <a href="/balance/topup" class="button">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</a>
    </div>

    <div class="section">
        <h3>üá®üá≥ –ö—É—Ä—Å —é–∞–Ω—è –Ω–∞ {{ now.strftime('%d.%m.%Y') }}:</h3>
        <ul>
            <li>350‚Äì2.500 ¬• ‚Äì <strong>{{ (yuan_rate * 1.08) | round(2) }}</strong> ‚ÇΩ (8%)</li>
            <li>2.500‚Äì10.000 ¬• ‚Äì <strong>{{ (yuan_rate * 1.05) | round(2) }}</strong> ‚ÇΩ (5%)</li>
            <li>10.000‚Äì30.000 ¬• ‚Äì <strong>{{ (yuan_rate * 1.04) | round(2) }}</strong> ‚ÇΩ (4%)</li>
            <li>30.000+ ¬• ‚Äì <strong>{{ (yuan_rate * 1.035) | round(2) }}</strong> ‚ÇΩ (3.5%)</li>
        </ul>
        <h4>üíµ –î–æ–ª–ª–∞—Ä: <strong>{{ usd_rate }}</strong> ‚ÇΩ</h4>
        <a href="/balance/history" class="button">üìä –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞</a>
        <a href="/profile" class="button">‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="/create_order" class="button">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</a>
        <button class="button" onclick="toggleTopups()" style="position: relative;">
          üí¥ –ú–æ–∏ –∑–∞—è–≤–∫–∏
          {% if active_topup_count > 0 %}
            <span style="
              position: absolute;
              top: -6px;
              right: -6px;
              background-color: red;
              color: white;
              border-radius: 50%;
              padding: 2px 6px;
              font-size: 11px;
            ">
              {{ active_topup_count }}
            </span>
          {% endif %}
        </button>

        {% if user.role == "admin" %}
            <a href="/admin/dashboard" class="button">üõ† –ê–¥–º–∏–Ω–∫–∞</a>
        {% endif %}
    </div>

    <div class="section">
        <h2>üì¶ –í–∞—à–∏ –∑–∞–∫–∞–∑—ã</h2>
        {% if orders %}
            {% for order in orders %}
                <div class="order">
                    <strong>–ó–∞–∫–∞–∑ #{{ order.id }}</strong>: {{ order.description }} ({{ order.created_at }})<br>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> {{ order.status }}<br>

                    {% if order.status == "–æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã" %}
                        <div style="margin-top: 10px;">
                            üí≥ <strong>–†–µ–∫–≤–∏–∑–∏—Ç—ã:</strong><br>
                            {{ order.payment_details or "–†–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã" }}<br>
                            <form action="/order/upload_payment/{{ order.id }}" method="get">
                                <button type="submit">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</button>
                            </form>
                            <form action="/order/payment_failed/{{ order.id }}" method="post">
                                <label style="font-size: 12px;">*–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</label>
                                <textarea name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –æ–ø–ª–∞—Ç—ã..." rows="2"></textarea>
                                <button type="submit" style="background-color: #bbb;">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å</button>
                            </form>
                        </div>
                    {% endif %}

                    {% if order.links %}
                        <div><strong>üîó –°—Å—ã–ª–∫–∏:</strong>
                            <ul>
                                {% for link in order.links %}
                                    <li><a href="{{ link.url }}" target="_blank">{{ link.url }}</a> ‚Äî {{ link.note }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    {% if order.attachments %}
                        <div><strong>üìé –§–∞–π–ª—ã:</strong>
                            <ul>
                                {% for att in order.attachments %}
                                    <li><a href="/{{ att.file_path }}" target="_blank">{{ att.filename }}</a> ‚Äî {{ att.note }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    {% if order.files %}
                        <div><strong>üìÅ –î–æ–∫—É–º–µ–Ω—Ç—ã:</strong>
                            <ul>
                                {% for file in order.files %}
                                    <li><a href="/download_file/{{ file.id }}" target="_blank">{{ file.filename }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    {% if order.status in ["–Ω–æ–≤—ã–π", "–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ", "—Å–æ–±—Ä–∞–Ω", "–æ–∂–∏–¥–∞–µ—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤"] %}
                        <div style="margin-top: 6px;">
                            {% if order.status == "—Å–æ–±—Ä–∞–Ω" %}
                                <form action="/order/confirm/{{ order.id }}" method="post" style="display:inline;">
                                    <button type="submit">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                                </form>
                            {% endif %}
                            <form action="/edit_order/{{ order.id }}" method="get" style="display:inline;">
                                <button type="submit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</p>
        {% endif %}
    </div>

    <div class="section" id="topupSection" style="display: none;">
        <h2>üí¥ –ó–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h2>
        {% if topup_requests %}
            {% for req in topup_requests %}
                <div class="topup">
                    <strong>{{ req.cny_amount }}</strong> ¬• (‚âà {{ req.rub_amount }} ‚ÇΩ)<br>
                    üìÖ {{ req.created_at.strftime("%d.%m.%Y %H:%M") }}<br>
                    üè∑Ô∏è <strong>–°—Ç–∞—Ç—É—Å:</strong>
                    {% if req.status == "waiting_for_details" %}
                        <span style="color: gray;">–û–∂–∏–¥–∞–µ–º —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</span>
                    {% elif req.status == "waiting_for_payment" %}
                        <span style="color: orange;">–û–∂–∏–¥–∞–µ–º –æ–ø–ª–∞—Ç—É</span><br>
                        üí≥ {{ req.payment_details }}<br>
                        <form action="/topup/upload/{{ req.id }}" method="get">
                            <button type="submit">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</button>
                        </form>
                    {% elif req.status == "waiting_for_confirmation" %}
                        <span style="color: blue;">–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã</span>
                        {% if req.payment_proof_path %}
                            üìé –§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
                        {% else %}
                            ‚ö†Ô∏è –§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                        {% endif %}
                    {% elif req.status == "confirmed" %}
                        <span style="color: green;">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>
                    {% elif req.status == "rejected" %}
                        <span style="color: red;">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p>–ó–∞—è–≤–æ–∫ –Ω–µ—Ç.</p>
        {% endif %}
    </div>

    <div class="section" style="text-align: center;">
        <a href="/logout" class="button" style="background-color: #777;">üö™ –í—ã–π—Ç–∏</a>
    </div>
<script>
  function toggleTopups() {
    const section = document.getElementById("topupSection");
    section.style.display = section.style.display === "none" ? "block" : "none";
  }
</script>

</body>
</html>